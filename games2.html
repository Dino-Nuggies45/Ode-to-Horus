<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rhythm Game</title>
<style>
    body{ background: #111; color: #fff; font-family: sans-serif; text-align: center; overflow: hidden; }
    #gameCanvas { background: #222; display: block; margin: 20px auto; border: 2px solid #fff; }
    #score { font-size: 24px; margin-top: 10px; }
    #startBtn { font-size: 24px; padding: 10px 20px; margin-top: 20px; cursor: pointer; }
    #gameOverScreen { display: none; color: white; text-align: center; margin-top: 50px;}
    #gameOverScreen button { font-size: 20px; margin: 5px; padding: 10px 20px; cursor: pointer;}
</style>
</head>
<body>
<h1>Rhythm Game</h1>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<div id="score">Score: 0</div>
<button id="startBtn">Start Game</button>
<audio id="song" src="song2.mp3?v=2"></audio>

<div id="gameOverScreen">
    <h2 id="highscoreText"></h2>
    <button id="homeBtn">Home</button>
    <button id="retryBtn">Try Again</button>
    <button id="pickSongBtn">Pick Another Song</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const keys = ['a', 's', 'd', 'f'];
    const keyX = {a:50, s:150, d:250, f:350}
    const noteSpeed = 200;
    let score = 0;

    const beats = [0.09, 0.6, 1.14, 1.67, 2.28, 2.74, 3.25, 3.72, 4.2, 4.67, 5.18, 5.64, 6.13, 6.59, 7.08, 7.57, 8.06, 8.52, 9.01, 9.47, 9.96, 10.43, 10.94, 11.4, 11.89, 12.35, 12.84, 13.33, 13.82, 14.28, 14.79, 15.35, 15.84, 16.42, 16.9, 17.37, 17.86, 18.34, 18.83, 19.3, 19.78, 20.27, 20.74, 21.22, 21.71, 22.18, 22.66, 23.15, 23.64, 24.1, 24.59, 25.05, 25.54, 26.01, 26.49, 26.98, 27.47, 27.96, 28.42, 28.91, 29.42, 29.95, 30.49, 31.05, 31.53, 32.02, 32.51, 32.97, 33.46, 33.95, 34.41, 34.9, 35.39, 35.85, 36.34, 36.83, 37.29, 37.78, 38.27, 38.73, 39.22, 39.71, 40.17, 40.66, 41.15, 41.63, 42.1, 42.56, 43.05, 43.54, 44.03, 44.49, 44.98, 45.46, 45.93, 46.42, 46.9, 47.37, 47.86, 48.34, 48.81, 49.3, 49.78, 50.25, 50.74, 51.22, 51.71, 52.18, 52.66, 53.15, 53.61, 54.1, 54.57, 55.05, 55.54, 56.03, 56.49, 56.98, 57.47, 57.96, 58.42, 58.91, 59.4, 59.86, 60.35, 60.84, 61.3, 61.79, 62.25, 62.76, 63.23, 63.69, 64.18, 64.69, 65.16, 65.62, 66.11, 66.62, 67.08, 67.55, 68.01, 68.52, 69.01, 69.47, 69.94, 70.45, 70.91, 71.38, 71.87, 72.38, 72.84, 73.31, 73.77, 74.28, 74.77, 75.23, 75.7, 76.21, 76.67, 77.14, 77.62, 78.14, 78.6, 79.06, 79.55, 80.04, 80.53, 80.99, 81.46, 81.97, 82.43, 82.9, 83.38, 83.89, 84.36, 0.09, 0.6, 1.14, 1.67, 2.28, 2.74, 3.25, 3.72, 4.2, 4.67, 5.18, 5.64, 6.13, 6.59, 7.08, 7.57, 8.06, 8.52, 9.01, 9.47, 9.96, 10.43, 10.94, 11.4, 11.89, 12.35, 12.84, 13.33, 13.82, 14.28, 14.79, 15.35, 15.84, 16.42, 16.9, 17.37, 17.86, 18.34, 18.83, 19.3, 19.78, 20.27, 20.74, 21.22, 21.71, 22.18, 22.66, 23.15, 23.64, 24.1, 24.59, 25.05, 25.54, 26.01, 26.49, 26.98, 27.47, 27.96, 28.42, 28.91, 29.42, 29.95, 30.49, 31.05, 31.53, 32.02, 32.51, 32.97, 33.46, 33.95, 34.41, 34.9, 35.39, 35.85, 36.34, 36.83, 37.29, 37.78, 38.27, 38.73, 39.22, 39.71, 40.17, 40.66, 41.15, 41.63, 42.1, 42.56, 43.05, 43.54, 44.03, 44.49, 44.98, 45.46, 45.93, 46.42, 46.9, 47.37, 47.86, 48.34, 48.81, 49.3, 49.78, 50.25, 50.74, 51.22, 51.71, 52.18, 52.66, 53.15, 53.61, 54.1, 54.57, 55.05, 55.54, 56.03, 56.49, 56.98, 57.47, 57.96, 58.42, 58.91, 59.4, 59.86, 60.35, 60.84, 61.3, 61.79, 62.25, 62.76, 63.23, 63.69, 64.18, 64.69, 65.16, 65.62, 66.11, 66.62, 67.08, 67.55, 68.01, 68.52, 69.01, 69.47, 69.94, 70.45, 70.91, 71.38, 71.87, 72.38, 72.84, 73.31, 73.77, 74.28, 74.77, 75.23, 75.7, 76.21, 76.67, 77.14, 77.62, 78.14, 78.6, 79.06, 79.55, 80.04, 80.53, 80.99, 81.46, 81.97, 82.43, 82.9, 83.38, 83.89, 84.36,.42, 29.95, 30.49, 31.05, 31.53, 32.02, 32.51, 32.97, 33.46, 33.95, 34.41, 34.9, 35.39, 35.85, 36.34, 36.83, 37.29, 37.78, 38.27, 38.73, 39.22, 39.71, 40.17, 40.66, 41.15, 41.63, 42.1, 42.56, 43.05, 43.54, 44.03, 44.49, 44.98, 45.46, 45.93, 46.42, 46.9, 47.37, 47.86, 48.34, 48.81, 49.3, 49.78, 50.25, 50.74, 51.22, 51.71, 52.18, 52.66, 53.15, 53.61, 54.1, 54.57, 55.05, 55.54, 56.03, 56.49, 56.98, 57.47, 57.96, 58.42, 58.91, 59.4, 59.86, 60.35, 60.84, 61.3, 61.79, 62.25, 62.76, 63.23, 63.69, 64.18, 64.69, 65.16, 65.62, 66.11, 66.62, 67.08, 67.55, 68.01, 68.52, 69.01, 69.47, 69.94, 70.45, 70.91, 71.38, 71.87, 72.38, 72.84, 73.31, 73.77, 74.28, 74.77, 75.23, 75.7, 76.21, 76.67, 77.14, 77.62, 78.14, 78.6, 79.06, 79.55, 80.04, 80.53, 80.99, 81.46, 81.97, 82.43, 82.9, 83.38, 83.89, 84.36, 84.82, 85.31, 85.8, 86.29, 86.75, 87.21, 87.72, 88.19, 88.65, 89.14, 89.65, 90.12, 90.58, 91.07, 91.56, 92.04, 92.51, 92.97, 93.48, 93.97, 94.44, 94.9, 95.41, 95.88, 96.34, 96.83, 97.34, 97.8, 98.27, 98.75, 99.24, 99.73, 100.19, 100.66, 101.17, 101.63, 102.1, 102.59, 103.1, 103.56, 104.03, 104.51, 105.0, 105.49, 105.95, 106.44, 106.95, 107.51, 108.0, 108.58, 109.06, 109.55, 110.02, 110.5, 110.97, 111.46, 111.94, 112.43, 112.9, 113.38, 113.87, 114.36, 114.82, 115.31, 115.8, 116.26, 116.75, 117.24, 117.7, 118.19, 118.65, 119.14, 119.63, 120.12, 120.58, 121.07, 121.56, 122.02, 122.51, 122.8, 57.47, 57.96, 58.42, 58.91, 59.4, 59.86, 60.35, 60.84, 61.3, 61.79, 62.25, 62.76, 63.23, 63.69, 64.18, 64.69, 65.16, 65.62, 66.11, 66.62, 67.08, 67.55, 68.01, 68.52, 69.01, 69.47, 69.94, 70.45, 70.91, 71.38, 71.87, 72.38, 72.84, 73.31, 73.77, 74.28, 74.77, 75.23, 75.7, 76.21, 76.67, 77.14, 77.62, 78.14, 78.6, 79.06, 79.55, 80.04, 80.53, 80.99, 81.46, 81.97, 82.43, 82.9, 83.38, 83.89, 84.36, 84.82, 85.31, 85.8, 86.29, 86.75, 87.21, 87.72, 88.19, 88.65, 89.14, 89.65, 90.12, 90.58, 91.07, 91.56, 92.04, 92.51, 92.97, 93.48, 93.97, 94.44, 94.9, 95.41, 95.88, 96.34, 96.83, 97.34, 97.8, 98.27, 98.75, 99.24, 99.73, 100.19, 100.66, 101.17, 101.63, 102.1, 102.59, 103.1, 103.56, 104.03, 104.51, 105.0, 105.49, 105.95, 106.44, 106.95, 107.51, 108.0, 108.58, 109.06, 109.55, 110.02, 110.5, 110.97, 111.46, 111.94, 112.43, 112.9, 113.38, 113.87, 114.36, 114.82, 115.31, 115.8, 116.26, 116.75, 117.24, 117.7, 118.19, 118.65, 119.14, 119.63, 120.12, 120.58, 121.07, 121.56, 122.02, 122.51, 122.97, 123.46, 123.95, 124.41, 124.9, 125.39, 125.88, 126.34, 126.83, 127.32, 127.78, 128.27, 128.75, 129.22, 129.71, 130.17, 130.66, 131.15, 131.63, 132.1, 132.59, 133.07, 133.54, 134.03, 134.51, 135, 84.82, 85.31, 85.8, 86.29, 86.75, 87.21, 87.72, 88.19, 88.65, 89.14, 89.65, 90.12, 90.58, 91.07, 91.56, 92.04, 92.51, 92.97, 93.48, 93.97, 94.44, 94.9, 95.41, 95.88, 96.34, 96.83, 97.34, 97.8, 98.27, 98.75, 99.24, 99.73, 100.19, 100.66, 101.17, 101.63, 102.1, 102.59, 103.1, 103.56, 104.03, 104.51, 105.0, 105.49, 105.95, 106.44, 106.95, 107.51, 108.0, 108.58, 109.06, 109.55, 110.02, 110.5, 110.97, 111.46, 111.94, 112.43, 112.9, 113.38, 113.87, 114.36, 114.82, 115.31, 115.8, 116.26, 116.75, 117.24, 117.7, 118.19, 118.65, 119.14, 119.63, 120.12, 120.58, 121.07, 121.56, 122.02, 122.51, 122.97, 123.46, 123.95, 124.41, 124.9, 125.39, 125.88, 126.34, 126.83, 127.32, 127.78, 128.27, 128.75, 129.22, 129.71, 130.17, 130.66, 131.15, 131.63, 132.1, 132.59, 133.07, 133.54, 134.03, 134.51, 135, 97, 111.46, 111.94, 112.43, 112.9, 113.38, 113.87, 114.36, 114.82, 115.31, 115.8, 116.26, 116.75, 117.24, 117.7, 118.19, 118.65, 119.14, 119.63, 120.12, 120.58, 121.07, 121.56, 122.02, 122.51, 122.97, 123.46, 123.95, 124.41, 124.9, 125.39, 125.88, 126.34, 126.83, 127.32, 127.78, 128.27, 128.75, 129.22, 129.71, 130.17, 130.66, 131.15, 131.63, 132.1, 132.59, 133.07, 133.54, 134.03, 134.51, 135.0, 135.47, 135.95, 136.44, 136.93, 137.49, 138.04, 138.58, 139.06, 139.53, 140.02, 140.5, 140.97, 141.46, 141.94, 142.41, 142.9, 143.38, 143.87, 144.34, 144.82, 145.31, 145.77, 146.26, 146.73, 147.297, 123.46, 123.95, 124.41, 124.9, 125.39, 125.88, 126.34, 126.83, 127.32, 127.78, 128.27, 128.75, 129.22, 129.71, 130.17, 130.66, 131.15, 131.63, 132.1, 132.59, 133.07, 133.54, 134.03, 134.51, 135.0, 135.47, 135.95, 136.44, 136.93, 137.49, 138.04, 138.58, 139.06, 139.53, 140.02, 140.5, 140.97, 141.46, 141.94, 142.41, 142.9, 143.38, 143.87, 144.34, 144.82, 145.31, 145.77, 146.26, 146.73, 147.20, 135.47, 135.95, 136.44, 136.93, 137.49, 138.04, 138.58, 139.06, 139.53, 140.02, 140.5, 140.97, 141.46, 141.94, 142.41, 142.9, 143.38, 143.87, 144.34, 144.82, 145.31, 145.77, 146.26, 146.73, 147.21, 147.7, 148.19, 148.65, 149.14, 149.61, 150.09, 150.58, 151.07, 151.53, 152.02, 152.51, 152.97, 153.46, 153.93, 154.41, 154.9, 155.39, 155.85, 156.34, 156.83, 157.29, 157.78, 158.27, 158.73, 159.22, 159.71, 160.17, 160.66, 161.15, 161.61, 162.1, 162.59, 163.05, 163.54, 164.03, 164.51, 164.98, 165.44, 165.93, 166.42, 166.91, 167.37, 167.86, 168.34, 168.81].map(b => ({time: b, spawned: false}));
    let activeNotes = []
    let spawnOffset = 2;
    let gameLoopId = null

    const song = document.getElementById('song');
    const startBtn = document.getElementById('startBtn');
    const gameOverScreen = document.getElementById('gameOverScreen')

    startBtn.addEventListener('click', () => {
        song.play().then(() => {
            requestAnimationFrame(gameLoop);
        }).catch(e => console.log("Song play blocked", e));
        startBtn.style.display = 'none';
    });

    document.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        if(keys.includes(key)) {
            for(let i = 0; i < activeNotes.length; i++) {
                const note = activeNotes[i];
                if(note.key === key && Math.abs(note.y - 500) < 30) {
                    score += 100;
                    document.getElementById('score').textContent = 'Score: ' + score;
                    activeNotes.splice(i, 1);
                    break;
                }
            }
        }

    });

    song.addEventListener('ended', () => {
        cancelAnimationFrame(gameLoopId);
        canvas.style.display = 'none';
        gameOverScreen.style.display = 'block';
        
        let highscore = localStorage.getItem('rhythmHighScore') || 0;

        if(score > highscore){
            highscoreText.textContent = `Congrats! our new highscore is ${score}`;
            localStorage.setItem('rhythmHighscore', score);
        } else {
            highscoreText.textContent = `Your highscore is ${highscore}. You scored ${score}`;
        }
    });

    document.getElementById('homeBtn').addEventListener('click', () => {
        window.location.href = 'index.html';
    });

    document.getElementById('retryBtn').addEventListener('click', () => {
        location.reload();
    });

    document.getElementById('pickSongBtn').addEventListener('click', () => {
        window.location.href = 'songs.html';
    });

    let lastTime = null;
    function gameLoop(timestamp) {
        if(!lastTime) lastTime = timestamp;
        const delta = (timestamp - lastTime) / 1000;
        lastTime = timestamp

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = 'yellow';
        ctx.fillRect(0, 500, canvas.width, 5);

        ctx.fillStyle = 'white';
        ctx.font = '24px sans-serif'
        keys.forEach(key => {
            ctx.fillText(key.toUpperCase(), keyX[key]-8, 580);
        });

        const currentTime = song.currentTime;
        beats.forEach((beat) => {
            if(!beat.spawned && currentTime >= beat.time - spawnOffset) {
                const randomKey = keys[Math.floor(Math.random()*keys.length)];
                activeNotes.push({key: randomKey, y: 0});
                beat.spawned = true;
            }
        });

        ctx.fillStyle = 'cyan';
        activeNotes.forEach(note => {
            note.y += noteSpeed * delta;
            ctx.fillRect(keyX[note.key]-25, note.y-25, 50, 50);
        });

        activeNotes = activeNotes.filter(note => note.y < canvas.height);

        gameLoopId = requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>