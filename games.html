<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rhythm Game</title>
<style>
    body{ background: #111; color: #fff; font-family: sans-serif; text-align: center; overflow: hidden; }
    #gameCanvas { background: #222; display: block; margin: 20px auto; border: 2px solid #fff; }
    #score { font-size: 24px; margin-top: 10px; }
    #startBtn { font-size: 24px; padding: 10px 20px; margin-top: 20px; cursor: pointer; }
    #gameOverScreen { display: none; color: white; text-align: center; margin-top: 50px;}
    #gameOverScreen button { font-size: 20px; margin: 5px; padding: 10px 20px; cursor: pointer;}
</style>
</head>
<body>
<h1>Rhythm Game</h1>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<div id="score">Score: 0</div>
<button id="startBtn">Start Game</button>
<audio id="song" src="song1.mp3"></audio>

<div id="gameOverScreen">
    <h2 id="highscoreText"></h2>
    <button id="homeBtn">Home</button>
    <button id="retryBtn">Try Again</button>
    <button id="pickSongBtn">Pick Another Song</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const keys = ['a', 's', 'd', 'f'];
    const keyX = {a:50, s:150, d:250, f:350}
    const noteSpeed = 200;
    let score = 0;

    const beats = [0.07, 0.7, 1.3, 1.9, 2.48, 3.09, 3.69, 4.3, 4.9, 5.48, 6.08, 6.69, 7.29, 7.89, 8.5, 9.1, 9.68, 10.26, 10.87, 11.47, 12.07, 12.68, 13.28, 13.86, 14.47, 15.07, 15.67, 16.25, 16.86, 17.46, 18.07, 18.67, 19.27, 19.88, 20.48, 21.06, 21.66, 22.27, 22.87, 23.48, 24.08, 24.66, 25.26, 25.87, 26.47, 27.07, 27.68, 28.26, 28.86, 29.47, 30.09, 30.67, 31.25, 31.86, 32.48, 33.07, 33.67, 34.27, 34.9, 35.46, 36.06, 36.66, 37.27, 37.87, 38.48, 39.06, 39.68, 40.26, 40.87, 41.47, 42.07, 42.68, 43.28, 43.86, 44.47, 45.07, 45.67, 46.28, 46.88, 47.48, 48.07, 48.67, 49.27, 49.88, 50.48, 51.06, 51.66, 52.27, 52.87, 53.48, 54.08, 54.66, 55.26, 55.87, 56.47, 57.07].map(b => ({time: b, spawned: false}));

    let activeNotes = []
    let spawnOffset = 2;
    let gameLoopId = null

    const song = document.getElementById('song');
    const startBtn = document.getElementById('startBtn');
    const gameOverScreen = document.getElementById('gameOverScreen')

    startBtn.addEventListener('click', () => {
        song.play().then(() => {
            requestAnimationFrame(gameLoop);
        }).catch(e => console.log("Song play blocked", e));
        startBtn.style.display = 'none';
    });

    document.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        if(keys.includes(key)) {
            for(let i = 0; i < activeNotes.length; i++) {
                const note = activeNotes[i];
                if(note.key === key && Math.abs(note.y - 500) < 30) {
                    score += 100;
                    document.getElementById('score').textContent = 'Score: ' + score;
                    activeNotes.splice(i, 1);
                    break;
                }
            }
        }

    });

    song.addEventListener('ended', () => {
        cancelAnimationFrame(gameLoopId);
        canvas.style.display = 'none';
        gameOverScreen.style.display = 'block';
        
        let highscore = localStorage.getItem('rhythmHighScore') || 0;

        if(score > highscore){
            highscoreText.textContent = `Congrats! our new highscore is ${score}`;
            localStorage.setItem('rhythmHighscore', score);
        } else {
            highscoreText.textContent = `Your highscore is ${highscore}. You scored ${score}`;
        }
    });

    document.getElementById('homeBtn').addEventListener('click', () => {
        window.location.href = 'index.html';
    });

    document.getElementById('retryBtn').addEventListener('click', () => {
        location.reload();
    });

    document.getElementById('pickSongBtn').addEventListener('click', () => {
        window.location.href = 'songs.html';
    });

    let lastTime = null;
    function gameLoop(timestamp) {
        if(!lastTime) lastTime = timestamp;
        const delta = (timestamp - lastTime) / 1000;
        lastTime = timestamp

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = 'yellow';
        ctx.fillRect(0, 500, canvas.width, 5);

        ctx.fillStyle = 'white';
        ctx.font = '24px sans-serif'
        keys.forEach(key => {
            ctx.fillText(key.toUpperCase(), keyX[key]-8, 580);
        });

        const currentTime = song.currentTime;
        beats.forEach((beat) => {
            if(!beat.spawned && currentTime >= beat.time - spawnOffset) {
                const randomKey = keys[Math.floor(Math.random()*keys.length)];
                activeNotes.push({key: randomKey, y: 0});
                beat.spawned = true;
            }
        });

        ctx.fillStyle = 'cyan';
        activeNotes.forEach(note => {
            note.y += noteSpeed * delta;
            ctx.fillRect(keyX[note.key]-25, note.y-25, 50, 50);
        });

        activeNotes = activeNotes.filter(note => note.y < canvas.height);

        gameLoopId = requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>